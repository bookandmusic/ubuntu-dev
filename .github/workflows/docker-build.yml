name: Build and Push Docker Image with WSL Export

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build, Push and Export for WSL
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. ç™»å½• GHCR
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # 3. èŽ·å–çŸ­æäº¤ SHA
      - name: Extract short commit SHA
        id: vars
        run: echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # 4. æž„å»ºå¹¶æŽ¨é€ AMD64 é•œåƒ
      - name: Build and push single-arch image (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/ubuntu-dev:latest
            ghcr.io/${{ github.repository_owner }}/ubuntu-dev:${{ env.COMMIT_SHA }}

      # 5. å¯¼å‡º WSL åˆ†å‘åŒ…
      - name: Prepare WSL distribution package
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/ubuntu-dev:${{ env.COMMIT_SHA }}
          DISTRO_NAME=ubuntu-dev-${{ env.COMMIT_SHA }}
          TAR_FILE=$DISTRO_NAME.tar
          
          # ä½¿ç”¨docker exportï¼ˆWSLå…¼å®¹æ ¼å¼ï¼‰
          docker run -d --name wsl_builder $IMAGE tail -f /dev/null
          docker export wsl_builder -o $TAR_FILE
          docker stop wsl_builder
          docker rm wsl_builder
          
          echo "TAR_FILE=$TAR_FILE" >> $GITHUB_ENV
          echo "DISTRO_NAME=$DISTRO_NAME" >> $GITHUB_ENV

      # 6. åŽ‹ç¼© tar æ–‡ä»¶
      - name: Compress tar file
        run: |
          # åŽ‹ç¼© tar æ–‡ä»¶
          gzip -9 "${{ env.TAR_FILE }}"
          COMPRESSED_FILE="${{ env.TAR_FILE }}.gz"
          echo "COMPRESSED_FILE=$COMPRESSED_FILE" >> $GITHUB_ENV
          
          # æ£€æŸ¥åŽ‹ç¼©åŽæ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -c%s "$COMPRESSED_FILE")
          echo "Compressed file size: $FILE_SIZE bytes"
          echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_ENV

      # 7. æ ¹æ®æ–‡ä»¶å¤§å°å†³å®šæ˜¯å¦åˆ†å‰²
      - name: Check and split file if needed
        run: |
          MAX_SIZE=2147483648  # 2GB
          
          if [ ${{ env.FILE_SIZE }} -gt $MAX_SIZE ]; then
            echo "Compressed file exceeds 2GB, splitting into parts..."
            split -b 1800m "${{ env.COMPRESSED_FILE }}" "${{ env.COMPRESSED_FILE }}.part."
            echo "UPLOAD_FILES=${{ env.COMPRESSED_FILE }}.part.*" >> $GITHUB_ENV
            echo "NEEDS_MERGE=true" >> $GITHUB_ENV
            echo "FILE_TYPE=compressed_split" >> $GITHUB_ENV
          else
            echo "Compressed file is under 2GB, no need to split"
            echo "UPLOAD_FILES=${{ env.COMPRESSED_FILE }}" >> $GITHUB_ENV
            echo "NEEDS_MERGE=false" >> $GITHUB_ENV
            echo "FILE_TYPE=compressed" >> $GITHUB_ENV
          fi

      # 8. åˆ›å»ºè¯¦ç»†çš„å¯¼å…¥è¯´æ˜Žæ–‡ä»¶
      - name: Create detailed instructions file
        run: |
          if [ "${{ env.NEEDS_MERGE }}" = "true" ]; then
            GUIDE_CONTENT='
          # WSL å¯¼å…¥æŒ‡å—

          ## æ–‡ä»¶ä¿¡æ¯
          - åˆ†å‘ç‰ˆåç§°: ubuntu-dev-${{ env.COMMIT_SHA }}
          - æ–‡ä»¶æ ¼å¼: åŽ‹ç¼©åˆ†å·çš„ tar.gz åŒ…
          - ä½¿ç”¨å‰éœ€è¦: åˆå¹¶åˆ†å· + è§£åŽ‹ç¼©

          ## æ­¥éª¤ 1: ä¸‹è½½æ–‡ä»¶
          ä¸‹è½½æ‰€æœ‰ `ubuntu-dev-${{ env.COMMIT_SHA }}.tar.gz.part.*` æ–‡ä»¶åˆ°åŒä¸€æ–‡ä»¶å¤¹

          ## æ­¥éª¤ 2: åˆå¹¶æ–‡ä»¶

          ### æ–¹æ³•ä¸€ï¼šä½¿ç”¨å‘½ä»¤æç¤ºç¬¦ï¼ˆCMD - æŽ¨èï¼‰
          ```cmd
          copy /b ubuntu-dev-${{ env.COMMIT_SHA }}.tar.gz.part.* ubuntu-dev-${{ env.COMMIT_SHA }}.tar.gz
          ```

          ### æ–¹æ³•äºŒï¼šä½¿ç”¨ PowerShell
          ```powershell
          cmd /c "copy /b ubuntu-dev-${{ env.COMMIT_SHA }}.tar.gz.part.* ubuntu-dev-${{ env.COMMIT_SHA }}.tar.gz"
          ```

          ## æ­¥éª¤ 3: è§£åŽ‹ç¼©æ–‡ä»¶
          ä½¿ç”¨å·¥å…·å¦‚ 7-Zip è§£åŽ‹, å¾—åˆ° ubuntu-dev-${{ env.COMMIT_SHA }}.tar

          ## æ­¥éª¤ 4: å¯¼å…¥åˆ° WSL
          åœ¨ PowerShell æˆ–å‘½ä»¤æç¤ºç¬¦ä¸­ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰ï¼š
          ```powershell
          # åˆ›å»ºå®‰è£…ç›®å½•
          mkdir C:\WSL\ubuntu-dev-${{ env.COMMIT_SHA }}

          # å¯¼å…¥ WSL åˆ†å‘ç‰ˆ
          wsl --import ubuntu-dev-${{ env.COMMIT_SHA }} C:\WSL\ubuntu-dev-${{ env.COMMIT_SHA }} ubuntu-dev-${{ env.COMMIT_SHA }}.tar --version 2

          # è¿è¡Œ WSL
          wsl -d ubuntu-dev-${{ env.COMMIT_SHA }}
          ```

          ## éªŒè¯å¯¼å…¥
          ```powershell
          wsl -l -v
          ```'
          else
            GUIDE_CONTENT='
          # WSL å¯¼å…¥æŒ‡å—

          ## æ–‡ä»¶ä¿¡æ¯
          - åˆ†å‘ç‰ˆåç§°: ubuntu-dev-${{ env.COMMIT_SHA }}
          - æ–‡ä»¶æ ¼å¼: åŽ‹ç¼©çš„ tar.gz åŒ…
          - ä½¿ç”¨å‰éœ€è¦: è§£åŽ‹ç¼©

          ## æ­¥éª¤ 1: ä¸‹è½½æ–‡ä»¶
          ä¸‹è½½ `ubuntu-dev-${{ env.COMMIT_SHA }}.tar.gz` æ–‡ä»¶

          ## æ­¥éª¤ 2: è§£åŽ‹ç¼©æ–‡ä»¶
          ä½¿ç”¨å·¥å…·å¦‚ 7-Zip è§£åŽ‹, å¾—åˆ° ubuntu-dev-${{ env.COMMIT_SHA }}.tar

          ## æ­¥éª¤ 3: å¯¼å…¥åˆ° WSL
          åœ¨ PowerShell æˆ–å‘½ä»¤æç¤ºç¬¦ä¸­ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰ï¼š
          ```powershell
          # åˆ›å»ºå®‰è£…ç›®å½•
          mkdir C:\WSL\ubuntu-dev-${{ env.COMMIT_SHA }}

          # å¯¼å…¥ WSL åˆ†å‘ç‰ˆ
          wsl --import ubuntu-dev-${{ env.COMMIT_SHA }} C:\WSL\ubuntu-dev-${{ env.COMMIT_SHA }} ubuntu-dev-${{ env.COMMIT_SHA }}.tar --version 2

          # è¿è¡Œ WSL
          wsl -d ubuntu-dev-${{ env.COMMIT_SHA }}
          ```

          ## éªŒè¯å¯¼å…¥
          ```powershell
          wsl -l -v
          ```'
          fi
          
          echo "$GUIDE_CONTENT" > WSL_IMPORT_GUIDE.md
          echo "GUIDE_FILE=WSL_IMPORT_GUIDE.md" >> $GITHUB_ENV

      # 9. åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      - name: Create Release with WSL distribution
        uses: ncipollo/release-action@v1.20.0
        with:
          tag: ${{ env.COMMIT_SHA }}
          name: WSL Distribution - ubuntu-dev-${{ env.COMMIT_SHA }}
          artifacts: |
            ${{ github.workspace }}/${{ env.UPLOAD_FILES }}
            ${{ github.workspace }}/${{ env.GUIDE_FILE }}
          body: |
            ## WSLæ“ä½œ
            ðŸ“– **è¯¦ç»†è¯´æ˜Žè¯·ä¸‹è½½ [WSL_IMPORT_GUIDE.md](../../releases/download/${{ env.COMMIT_SHA }}/WSL_IMPORT_GUIDE.md)**
            
            ## é•œåƒä¿¡æ¯
            - åŸºäºŽæäº¤: ${{ env.COMMIT_SHA }}
            - é•œåƒåœ°å€: ghcr.io/${{ github.repository_owner }}/ubuntu-dev:${{ env.COMMIT_SHA }}
          allowUpdates: true
          generateReleaseNotes: false

      # 10. æ¸…ç†æ­¥éª¤
      - name: Clean up
        if: always()
        run: |
          # åˆ é™¤æœ¬åœ°ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶
          rm -f ${{ env.TAR_FILE }} ${{ env.COMPRESSED_FILE }} ${{ env.COMPRESSED_FILE }}.part.* ${{ env.GUIDE_FILE }} 2>/dev/null || true